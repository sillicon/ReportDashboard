/*! qadashboard 2018-03-18 by sillicon */

const e=require("express"),t=require("path"),r=require("moment"),n=e.Router();function s(e,t){e.find().toArray(function(e,r){if(e)t(e,n);else{var n={};r.forEach(function(e){var t=[e],r=[0];if(null!=e.child)for(;t.length>0;)r[r.length-1]<=t[t.length-1].child.length-1?null!=t[t.length-1].child[r[r.length-1]].child?(t.push(t[t.length-1].child[r[r.length-1]]),r.push(0)):(n[t[t.length-1].child[r[r.length-1]].id]=t[t.length-1].child[r[r.length-1]].testName,r[r.length-1]++):(r.pop(),t.pop(),r[r.length-1]++)},this),t(e,n)}})}function a(e){for(var t=["reportEnvir1","reportEnvir2","reportEnvir3"],r=0;r<t.length;r++)if(e.hasOwnProperty(t[r])&&"true"===e[t[r]])return!0;return!1}function o(e){var t=r(e,["YYYY-MM-DD","MM/DD/YYYY"]).toDate();return t=new Date(t.getTime()-6e4*t.getTimezoneOffset())}n.get("/queryReports",function(e,t){if(a(e.query)){var r=e.app.get("dbConnection"),n=r.collection("reportResult"),i={$or:[]};if("true"===e.query.reportEnvir1&&i.$or.push({envirTested:"Envir1"}),"true"===e.query.reportEnvir2&&i.$or.push({envirTested:"Envir2"}),"true"===e.query.reportEnvir3&&i.$or.push({envirTested:"Envir3"}),null!=e.query.reportCategory){var u=e.query.reportCategory.split(",");for(let e=0;e<u.length;e++)u[e]=parseInt(u[e]);i.testID={$in:u}}"Date"===e.query.requestType?""!==e.query.reportDate?i.testDate={$eq:o(e.query.reportDate)}:t.status(400).send("Bad Request, no date input."):"null"===e.query.startDate?i.testDate={$gte:o("01/01/2017"),$lte:o(e.query.endDate)}:i.testDate={$gte:o(e.query.startDate),$lte:o(e.query.endDate)};var l=[[],[],[]];n.find(i).project({_id:0}).toArray(function(n,a){n?(console.log(n),t.status(500).send("Database query failed!")):s(r.collection("reportCategory"),function(r,n){if(r)console.log(r),t.status(500).send("Database query failed!");else{a.forEach(function(e){e.testName=n[e.testID],"Envir1"==e.envirTested?l[0].push(e):"Envir2"==e.envirTested?l[1].push(e):l[2].push(e)},this);for(var s=0;s<l.length;s++)l[s].sort(function(t,r){return"Date"==e.query.sort?t.testDate<r.testDate?-1:t.testDate>r.testDate?1:t.testName<r.testName?-1:t.testName>r.testName?1:0:t.testName<r.testName?-1:t.testName>r.testName?1:t.testDate<r.testDate?-1:t.testDate>r.testDate?1:0});t.send(l)}})})}else t.status(400).send("Missing query parameter!")}),n.get("/getLatestReports",function(e,t){var r=e.app.get("dbConnection"),n=r.collection("reportResult"),a={envirTested:e.query.envir||null,testDate:o(e.query.testDate)};n.find(a).project({}).toArray(function(e,n){e?(console.log(e),t.status(500).send("Database query failed!")):s(r.collection("reportCategory"),function(e,r){e?(console.log(e),t.status(500).send("Database query failed!")):(n.forEach(function(e){e.testName=r[e.testID]},this),n.sort(function(e,t){return e.testName<t.testName?-1:e.testName>t.testName?1:e.fileName<t.fileName?-1:e.fileName>t.fileName?1:0}),t.send(n))})})}),n.get("/getIDRef",function(e,t){s(e.app.get("dbConnection").collection("reportCategory"),function(e,r){e?(console.log(e),t.status(500).send("Database query failed!")):t.send(r)})}),module.exports=n;