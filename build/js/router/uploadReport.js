/*! qadashboard 2018-03-27 by sillicon */

const e=require("express"),t=require("path"),n=require("fs"),o=require("moment"),r=require("mongodb").ObjectID,s=e.Router();function i(e,t,n){e.find().toArray(function(e,o){if(e)console.log(e),n(e,r);else{for(var r="",s=0;s<o.length;s++){var i=o[s],a=[i],l=[0];if(null!=i.child&&""===r)for(;a.length>0;)if(l[l.length-1]<=a[a.length-1].child.length-1)if(null!=a[a.length-1].child[l[l.length-1]].child)a.push(a[a.length-1].child[l[l.length-1]]),l.push(0);else{if(a[a.length-1].child[l[l.length-1]].id===t){r=a[a.length-1].child[l[l.length-1]].testName;break}l[l.length-1]++}else l.pop(),a.pop(),l[l.length-1]++}n(e,r)}})}function a(e){var t=o(e,["YYYY-MM-DD","MM/DD/YYYY"]).toDate(),n=t.getDate(),r=t.getMonth()+1,s=t.getFullYear(),i=new Date,a=i.getHours(),l=i.getMinutes(),d=i.getSeconds();return n<10&&(n="0"+n),r<10&&(r="0"+r),a<10&&(a="0"+a),l<10&&(l="0"+l),d<10&&(d="0"+d),r+"_"+n+"_"+s+"_"+a+"_"+l+"_"+d}function l(e){var t=o(e,["YYYY-MM-DD","MM/DD/YYYY"]).toDate();return t=new Date(t.getTime()-6e4*t.getTimezoneOffset())}s.post("/uploadReport",function(e,o){if(e.body.hasOwnProperty("reportEnvi")&&e.body.hasOwnProperty("testID")&&e.body.hasOwnProperty("reportDate")&&e.body.hasOwnProperty("reportHTML")&&e.body.hasOwnProperty("reportResult")){var r=e.app.get("dbConnection"),s=r.collection("reportResult"),d=e.body.reportHTML,u=a(e.body.reportDate);if(e.body.hasOwnProperty("reportName"))p(e.body.reportName+u+".html");else i(r.collection("reportCategory"),parseInt(e.body.testID),function(e,t){e?o.status(500).send("Database query failed!"):p(t.replace(/\s+/g,"")+u+".html")})}else o.status(400).send("Bad Request. Missing important request parameter.");function p(r){var i,a=t.join(t.dirname(__dirname),"public","report",r);if("pass"===e.body.reportResult.toLowerCase())i="Pass";else{if("fail"!==e.body.reportResult.toLowerCase())return void o.status(404).send("Test result parameter is not correct!");i="Fail"}var u={testID:parseInt(e.body.testID),testDate:l(e.body.reportDate),testResult:i,fileName:r,browser:e.body.reportBrowser,hiveTested:e.body.reportHive};"envir1"===e.body.reportEnvi.toLowerCase()?u.envirTested="Envir1":"envir2"===e.body.reportEnvi.toLowerCase()?u.envirTested="Envir2":u.envirTested="Envir3",e.body.hasOwnProperty("comments")&&(u.comments=e.body.comments,u.comments[0].commentTime=new Date),e.body.hasOwnProperty("reportURL")?(u.reportURL=e.body.reportURL,s.insertOne(u).then(function(e){o.send("Upload Complete!")},function(e){throw o.send(e),e})):(n.closeSync(n.openSync(a,"w")),r.indexOf("SharingAPI")>-1&&(d="<body style='white-space: pre-wrap;'>"+d+"</body>"),n.writeFile(a,d,"utf8",function(e){if(e)throw o.status(500).send("Write html into database failed!"),e;s.insertOne(u).then(function(e){o.send("Upload Complete!")},function(e){throw o.send(e),e})}))}}),s.post("/publishComment",function(e,t){var n=e.app.get("dbConnection").collection("reportResult");n.find({_id:r(e.body._id)}).toArray(function(o,s){if(o)t.status(500).send("Database query failed!");else{var i=s[0];if(i.hasOwnProperty("comments")){var a=i.comments;a.push({commenter:e.body.commenter,comment:e.body.commentText,commentTime:new Date}),n.update({_id:r(e.body._id)},{$set:{comments:a}})}else n.update({_id:r(e.body._id)},{$set:{comments:[{commenter:e.body.commenter,comment:e.body.commentText,commentTime:new Date}]}});t.status(200).send("Post comment complete.")}})}),s.get("/deleteResult",function(e,o){let s=e.app.get("dbConnection").collection("reportResult");s.find({_id:r(e.query._id)}).toArray(function(i,a){if(i||0===a.length)o.status(500).send("Unable to find the report in database! Maybe it's already deleted.");else{let i=a[0],l=t.join(t.dirname(__dirname),"public","report",i.fileName);n.stat(l,function(t,i){i&&n.unlinkSync(l),s.deleteOne({_id:r(e.query._id)}).then(function(e){e.deletedCount>0?o.status(200).send("Delete complete."):o.status(500).send("Unable to delete the result.")})})}})}),s.get("/alterResult",function(e,t){let n=e.app.get("dbConnection").collection("reportResult");n.find({_id:r(e.query._id)}).toArray(function(o,s){if(o||0===s.length)t.status(500).send("Unable to find the report in database!");else{let o="Pass"===s[0].testResult?"Fail":"Pass";n.update({_id:r(e.query._id)},{$set:{testResult:o}}).then(function(e){e.result.ok>0&&e.result.nModified>0?t.status(200).send("Alter result complete."):t.status(500).send("Unable to alter the result.")})}})}),module.exports=s;