/*! qadashboard 2018-03-18 by sillicon */

window.onload=function(){let e=document.getElementById("holderbox"),t=document.getElementById("onDate"),a=document.getElementById("testDate"),n=document.getElementById("dateRange"),s=document.getElementById("dateRange1"),r=document.getElementById("dateRange2"),i=document.getElementById("onDays"),l=document.getElementById("withinDays"),o=(document.getElementById("sourceUpload"),document.getElementById("testDate")),c=document.getElementById("submitBut"),d=document.getElementById("categoryCheck"),u=(document.getElementById("caterogyList"),document.getElementById("envir1Chb")),p=document.getElementById("envir2Chb"),f=document.getElementById("envir3Chb"),h=(document.getElementById("charts"),document.getElementById("reportList"));document.querySelectorAll("#onDate,#dateRange,#onDays").forEach(function(e){e.addEventListener("change",function(){C()})}),document.querySelectorAll("#testDate,#cateValue,#envir1Chb,#envir2Chb,#envir3Chb").forEach(function(e){e.addEventListener("change",function(){b()})}),document.querySelectorAll("#dateRange1,#dateRange2").forEach(function(e){e.addEventListener("change",function(){L()})}),document.querySelector("#categoryCheck").addEventListener("change",function(){R()}),document.querySelector("#submitBut").addEventListener("click",function(){!function(){var e,n={reportEnvir1:u.checked,reportEnvir2:p.checked,reportEnvir3:f.checked};t.checked?(n.requestType="Date",n.reportDate=a.value):(n.requestType="Range",dateRange.checked?(n.startDate=s.value,n.endDate=r.value):(l.value>0?((e=new Date).setDate(e.getDate()-l.value),n.startDate=e.getMonth()+1+"/"+e.getDate()+"/"+e.getFullYear()):n.startDate=null,e=new Date,n.endDate=e.getMonth()+1+"/"+e.getDate()+"/"+e.getFullYear()));d.checked&&(n.reportCategory=document.querySelector("#cateValue").value);x(n),history.pushState(null,null,E(n))}()}),document.querySelector("#back").addEventListener("click",function(){location.href="home.html"}),isOpera=!!window.opr&&!!opr.addons||!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0,isFirefox="undefined"!=typeof InstallTrigger,isSafari=/constructor/i.test(window.HTMLElement)||"[object SafariRemoteNotification]"===(!window.safari||safari.pushNotification).toString(),isIE=!!document.documentMode,isEdge=!isIE&&!!window.StyleMedia,isChrome=!!window.chrome&&!!window.chrome.webstore,isBlink=(isChrome||isOpera)&&!!window.CSS;for(var m=["Last 3 days","Last week","Last 2 weeks","Last 3 weeks","Last 4 weeks","All Records"],g=[3,7,14,21,28,-1],y=0;y<m.length;y++)l.options[y]=new Option(m[y],g[y]);var v=new XMLHttpRequest;function x(t){var a=document.createElement("button");a.textContent="Back",a.id="backToForm",a.addEventListener("click",function(){if("none"===e.style.display){var a=document.getElementById("backToForm"),n=document.getElementById("charts");a.outerHTML="",B(e),T(h),window.setTimeout(function(){n.innerHTML="",document.getElementById("tooltip").style.opacity=0},400),t.hasOwnProperty("reportEnvir1")&&t.reportEnvir1?u.checked=!0:u.checked=!1}}),e.parentNode.insertBefore(a,e.nextSibling),a.className="navigation",T(e),B(h),h.innerHTML='<div id ="loader" class="loader"></div>';var n=new XMLHttpRequest;n.onreadystatechange=function(){if(4==this.readyState&&200===this.status){for(var e=JSON.parse(this.responseText),t=0,a=[{name:"Envir1"},{name:"Envir2"},{name:"Envir3"}],n=0;n<e.length;n++)e[n].length>0&&(t+=1,k(e[n],a[n].name));if(0===t)h.style.textAlign="Center",h.innerHTML="<font size = '10px'>No Records Found!</font>";else{1===t?h.style.width="40%":2===t?(h.style.width="60%",h.style.minWidth="400px"):3===t&&(h.style.width="90%",h.style.minWidth="550px");var s='<table style= "width: 100%; margin: auto" class = "masterTable"><tr>';for(n=0;n<e.length;n++)e[n].length>0&&(s+="<th>"+e[n][0].envirTested+"</th>");s+="</tr><tr>";for(n=0;n<e.length;n++)e[n].length>0&&(s+="<td>"+D(e[n])+"</td>");s+="</tr></table>",h.innerHTML=s}h.style.display="block"}else 400===this.status&&(h.style.textAlign="Center",h.innerHTML="<font size = '10px'>"+this.responseText+"</font>")},n.open("GET","./queryReports"+E(t)),n.send()}function b(){(u.checked||p.checked||f.checked)&&(!d.checked||d.checked&&""!=document.querySelector("#cateValue").value)&&(t.checked&&""!==a.value||n.checked&&w(s.value)&&w(r.value)&&new Date(s.value)<=new Date(r.value)||i.checked)?c.className=c.className.replace(/(?:^|\s)buttonDisabled(?!\S)/g,""):c.className.indexOf("buttonDisabled")<0&&(c.className+=" buttonDisabled")}function w(e){var t=new Date(e);return!isNaN(t)}function E(e){return"?"+Object.keys(e).map(function(t){return t+"="+e[t]}).join("&")}function k(e,t){d3.select("#charts").append("span").html("<b>"+t+"</b>");for(var a=[],n=[],s=[],r=[],i=[],l=0,o=0,c=0,d=0;d<e.length;d++)"Pass"===e[d].testResult?(o+=1,r.push(e[d].fileName)):(c+=1,i.push(e[d].fileName)),d<e.length-1?e[d].testID!==e[d+1].testID?(l=o/(o+c),n.push({date:e[d].testDate,ratio:l,counts:o+c,testName:e[d].testName,passFiles:r,failFiles:i}),r=[],i=[],o=0,c=0,s.push(n),a.push(e[d].testName),n=[]):e[d].testDate!=e[d+1].testDate&&(l=o/(o+c),n.push({date:e[d].testDate,ratio:l,counts:o+c,testName:e[d].testName,passFiles:r,failFiles:i}),r=[],i=[],o=0,c=0):(l=o/(o+c),n.push({date:e[d].testDate,ratio:l,counts:o+c,testName:e[d].testName,passFiles:r,failFiles:i}),r=[],i=[],o=0,c=0,s.push(n),a.push(e[d].testName),n=[]);var u=new Date(Date.parse(d3.min(s,function(e){return d3.extent(e,function(e){return A(new Date(e.date))})[0]}))),p=new Date(Date.parse(d3.max(s,function(e){return d3.extent(e,function(e){return A(new Date(e.date))})[1]}))),f=Math.round((p-u)/1e3/3600/24),h={top:20,right:20,bottom:40,left:100},m=960,g=Math.max(250,60*a.length),y=m-h.left-h.right,v=g-h.top-h.bottom,x=40,b=d3.select("#charts").append("svg").attr("id",t).attr("style","width: "+m+"px; height: "+g+"px;"),w=d3.scaleTime().range([0,y]).domain([u,O(p,1)]),E=d3.scaleBand().range([v,0]).padding(.1).domain(a),k=d3.axisBottom(w);k.tickValues(q(u,O(p,1),Math.round(Math.max(80*f/m,1)))).tickFormat(d3.timeFormat("%m-%d"));var D=d3.axisLeft(E),T=d3.zoom().scaleExtent([1,Math.round(80*f/m)]).translateExtent([[0,0],[y,v]]).extent([[0,0],[y,v]]).on("zoom",function(){var e=d3.select(".tooltip");e.style("opacity",0),(e=d3.select(".testListTip")).style("display","none");var t=b.select(".clicked");!1===t.empty()&&t.attr("class",t.attr("class").split(" ")[0]).style("fill","");var a=d3.event.transform.rescaleX(w);C=B.selectAll(".passBar"),R=B.selectAll(".failBar"),S(C,a,"pass"),S(R,a,"fail"),b.selectAll("rect").filter(function(){var e=this.attributes.transform.value;if(e=e.slice(e.indexOf("(")+1,e.indexOf(",")),(e=parseFloat(e))<99||e>y+100)return[this]}).style("display","none"),b.selectAll("rect").filter(function(){var e=this.attributes.transform.value;if(e=e.slice(e.indexOf("(")+1,e.indexOf(",")),(e=parseFloat(e))>98&&e<y+101)return[this]}).style("display","block"),L.tickValues(q(u,O(p,1),Math.round(Math.max(80*f/m/d3.event.transform.k,1)))),N.call(L.scale(a)),N.selectAll("g").filter(function(){var e=this.attributes.transform.value;if(e=e.slice(e.indexOf("(")+1,e.indexOf(",")),(e=parseFloat(e))<-1||e>y+1)return[this]}).remove(),k.tickValues(q(u,O(p,1),Math.round(Math.max(80*f/m/d3.event.transform.k,1)))),F.call(k.scale(a)),F.selectAll("g").filter(function(){var e=this.attributes.transform.value;if(e=e.slice(e.indexOf("(")+1,e.indexOf(",")),(e=parseFloat(e))<-1||e>y+1)return[this]}).remove()}),B=b.append("g").attr("id","bars"),C=B.selectAll(".passBar"),R=B.selectAll(".failBar");for(d=0;d<s.length;d++)I(C,s[d],"pass"),I(R,s[d],"fail");C=B.selectAll(".passBar"),R=B.selectAll(".failBar"),S(C,w,"pass"),S(R,w,"fail"),M(C,"pass"),M(R,"fail"),d3.selectAll("rect").filter(function(e,t,a){if(0===parseFloat(a[t].getAttribute("width")))return e}).remove();var L=d3.axisTop(w);L.ticks(d3.timeDay.every(Math.round(Math.max(80*f/m,1)))).tickSize(-v).tickFormat("");var N=b.append("g").attr("transform","translate("+h.left+", 0)").attr("class","gridLine");N.call(L);var F=b.append("g").attr("transform","translate("+h.left+","+v+")").attr("class","xAxis");function I(e,t,a){e.data(t).enter().append("rect").attr("class",function(){return"pass"===a?"passBar":"failBar"})}function S(e,t,a){e.attr("width",function(e){return"pass"===a?t(O(A(e.date),e.ratio))-t(A(e.date)):t(O(A(e.date),1-e.ratio))-t(A(e.date))}).attr("transform",function(e){return"pass"===a?"translate("+(h.left+t(A(e.date)))+", 0)":"translate("+(h.left+t(O(A(e.date),e.ratio)))+", 0)"}).attr("height",x).attr("y",function(e){return E(e.testName)+(E.bandwidth()-x)/2})}function M(e,t){e.on("mouseover",function(e){var a=this,n=d3.select(".tooltip");n.transition().duration(300).style("opacity",.9),n.html(function(){var a,n;return"pass"===t?(a=Math.round(e.ratio*e.counts),n=" passed"):(a=Math.round((1-e.ratio)*e.counts),n=" failed"),"<span>"+a+(a>1?" tests":" test")+n+"</span><br>"}).style("left",function(){var e,t=a.getBoundingClientRect().left,n=a.getBoundingClientRect().width,s=this.getBoundingClientRect().width;return isSafari||isEdge?e=document.getElementsByTagName("body")[0].scrollLeft:(isChrome||isFirefox||isIE)&&(e=document.getElementsByTagName("html")[0].scrollLeft),t+n/2-s/2+e+"px"}).style("top",function(){var e,t=a.getBoundingClientRect().top,n=this.getBoundingClientRect().height;return isSafari||isEdge?e=document.getElementsByTagName("body")[0].scrollTop:(isChrome||isFirefox||isIE)&&(e=document.getElementsByTagName("html")[0].scrollTop),e+t-n-10+"px"})}).on("mouseout",function(){d3.select(".tooltip").transition().duration(200).style("opacity",0)}).on("click",function(e){var a=d3.select(this),n=this,s=d3.select(".testListTip");if(a.attr("class").indexOf("clicked")>-1)a.attr("class",a.attr("class").split(" ")[0]),a.attr("style",""),s.style("display","none");else{var r=b.select(".clicked");!1===r.empty()&&r.attr("class",r.attr("class").split(" ")[0]).style("fill",""),a.attr("class",a.attr("class")+" clicked"),a.style("fill",window.getComputedStyle(this).fill),s.html(function(){var a="";if("pass"===t){e.passFiles.length>1?a+="<span>Passed Reports:</span><br>":a+="<span>Passed Report:</span><br>";for(var n=0;n<e.passFiles.length;n++)a+="<span><a href='.\\report\\"+e.passFiles[n]+"' target='_blank'>"+e.passFiles[n]+"</a></span><br>"}else{e.failFiles.length>1?a+="<span>Failed Reports:</span><br>":a+="<span>Failed Report:</span><br>";for(n=0;n<e.failFiles.length;n++)a+="<span><a href='.\\report\\"+e.failFiles[n]+"' target='_blank'>"+e.failFiles[n]+"</a></span><br>"}return a}),s.style("display","block"),s.style("left",function(){for(var e,t,a,s=n.getBoundingClientRect().left,r=n.getBoundingClientRect().width,i=this.getBoundingClientRect().width,l=document.styleSheets,o=0;o<l.length;o++)if(l[o].href.indexOf("main")>-1){t=isFirefox?l[o].cssRules:l[o].rules,o=l.length;for(var c=0;c<t.length;c++)"div.testListTip::after"===t[c].selectorText&&(a=t[c],c=t.length)}return isIE?a.style.margin="-5px 0px 0px -16px":a.style.margin="-5px 0px 0px -"+(i/2+10)+"px",isSafari||isEdge?e=document.getElementsByTagName("body")[0].scrollLeft:(isChrome||isFirefox||isIE)&&(e=document.getElementsByTagName("html")[0].scrollLeft),s+r+e+10+"px"}).style("top",function(){var e,t=n.getBoundingClientRect().top,a=n.getBoundingClientRect().height,s=this.getBoundingClientRect().height;return isSafari||isEdge?e=document.getElementsByTagName("body")[0].scrollTop:(isChrome||isFirefox||isIE)&&(e=document.getElementsByTagName("html")[0].scrollTop),e+t+a/2-s/2+"px"})}})}function O(e,t){var a=new Date(Date.parse(e));return a.setHours(Math.round(24*t-24*t%1)),a.setMinutes(Math.round(24*t%1*60)),a}function A(e){var t=new Date(e);return t=new Date(t.getTime()+6e4*t.getTimezoneOffset())}function q(e,t,a){for(var n=[],s=0;O(e,s)<=t;)n.push(O(e,s)),s+=a;return n}F.call(k).selectAll("text").style("text-anchor","middle"),b.append("g").attr("transform","translate("+h.left+", 0)").attr("class","yAxis").call(D).selectAll("text").attr("class","cateName").style("text-anchor","start").call(function(e,t){e.each(function(){for(var e,a=d3.select(this),n=a.text(),s=(e=n,["/","&","-"].forEach(function(t){var a=new RegExp(t,"g");e=e.replace(a,t+" ")}),e).split(/\s+/),r=a.attr("x"),i=a.attr("y"),l=parseFloat(a.attr("dy")||0),o=a.text(null).append("tspan").attr("x",r).attr("y",i).attr("dy",l+"em"),c=0;c<s.length;c++)s[c]=v(s[c]);for(var d,u,p=(n=s.join(" ")).split(/\s+/).reverse(),f=[],m=0,g=["/","&","-"];d=p.pop();)f.push(d),o.text(f.join(" ")),o.node().getComputedTextLength()>t&&(f.pop(),u=f.join(" "),g.forEach(function(e){u=u.replace(e+" ",e)}),o.text(u),f=[d],o=a.append("tspan").attr("x",r).attr("y",i).attr("dy",1.1*++m+l+"em").text(d));var y=parseInt(window.getComputedStyle(a._groups[0][0]).fontSize.slice(0,-2));function v(e){if(o.text(e),o.node().getComputedTextLength()>t)for(var a=e.split(""),n="",s=0;s<a.length;s++)n+=a[s],o.text(n),o.node().getComputedTextLength()>t&&("-"!==a[s-1]&&(e=e.slice(0,s-1)+"- "+v(e.slice(s-1))),s=a.length);return e}a.attr("transform","translate(-"+(h.left-13)+", -"+m/2*1.1*y+")")})},h.left-12),b.on("click",function(){if("rect"!=d3.event.target.tagName){var e=d3.select(".testListTip"),t=b.select(".clicked");!1===t.empty()&&t.attr("class",t.attr("class").split(" ")[0]).style("fill",""),e.style("display","none")}}),b.call(T),function(e){var t,a=e.height();t=isChrome||isIE?e.get(0).scrollHeight:parseInt(e.height());e.off("mousewheel").on("mousewheel",function(e){var n=this.scrollTop===t-a&&e.deltaY<0||0===this.scrollTop&&e.deltaY>0;return!n})}($("#"+t))}function D(e){var t='<table style="width: 100%; margin: auto" class = "detailTable"><tr><th>Test Name</th><th>Test Date</th><th>Link</th><th>Result</th></tr>';return e.forEach(function(e){var a="<tr><td>"+e.testName+"</td><td>"+function(e){var t=new Date(e),a=(t=new Date(t.getTime()+6e4*t.getTimezoneOffset())).getDate(),n=t.getMonth()+1,s=t.getFullYear();a<10&&(a="0"+a);n<10&&(n="0"+n);return n+"/"+a+"/"+s}(e.testDate)+'</td><td style="text-overflow: ellipsis;"><a href=\'.\\report\\'+e.fileName+"' target='_blank'>"+e.fileName+"</a></td>",n="<td>";"Pass"===e.testResult?n+='<font color="#31c631"><b>'+e.testResult+"</b></font></td></tr>":n+='<font color="#f75656"><b>'+e.testResult+"</b></font></td></tr>",t+=a+n}),t+="</table>"}function T(e){e.style.opacity="0",e.style.height="0px",window.setTimeout(function(){e.style.display="none"},400)}function B(e){e.style.opacity="1",e.style.height="",window.setTimeout(function(){e.style.display="block"},400)}function C(){t.checked?(o.disabled=!1,l.disabled=!0,s.disabled=!0,r.disabled=!0):i.checked?(o.disabled=!0,l.disabled=!1,s.disabled=!0,r.disabled=!0):(o.disabled=!0,l.disabled=!0,s.disabled=!1,r.disabled=!1),b()}function R(){d.checked?$("#multi-select").removeClass("disabled"):$("#multi-select").addClass("disabled"),b()}function L(){w(s.value)&&("date"!=$("#testDate")[0].type?$("#dateRange2").datepicker("option","minDate",new Date(s.value)):(r.min=s.value,new Date(s.value)>new Date(r.value)&&(r.value=s.value))),b()}v.onreadystatechange=function(){if(4==this.readyState&&200==this.status){"date"!=$("#testDate")[0].type&&($("#testDate").datepicker(),$("#dateRange1").datepicker(),$("#dateRange2").datepicker()),document.querySelector("body").addEventListener("click",function(e){"rect"!=e.target.tagName&&(document.querySelector("#testListTip").style.display="none")});var e=JSON.parse(this.responseText),o=document.querySelector("#multi-select div.menu"),c=Object.keys(e);for(let t=0;t<c.length;t++)if(["30","31"].indexOf(c[t])<0){var h=document.createElement("div");h.className="item",h.setAttribute("data-value",c[t]),h.textContent=e[c[t]],o.appendChild(h)}if($("#multi-select").dropdown(),window.location.href.indexOf("?")>-1){var m=function(e){for(var t={},a=e.split("?")[1].split("&"),n=0;n<a.length;n++){var s=a[n].split("=")[0],r=decodeURI(a[n].split("=")[1]);t[s]="true"===r||"false"!==r&&r}return t}(window.location.href);"Date"==m.requestType?(t.checked=!0,a.value=m.reportDate):"Range"==m.requestType&&("null"!=m.startDate?(n.checked=!0,s.value=m.startDate,r.value=m.endDate,L()):(i.checked=!0,l.selectedIndex=l.childElementCount-1)),m.hasOwnProperty("reportCategory")&&(d.checked=!0,R(),$("#multi-select").dropdown("set selected",m.reportCategory.split(","))),m.reportEnvir1&&(u.checked=!0),m.reportEnvir2&&(p.checked=!0),m.reportEnvir3&&(f.checked=!0),x(m)}R(),C()}else 4==this.readyState&&(document.querySelector("#holderbox").innerHTML=this.responseText,document.querySelector("#reportList").innerHTML=this.responseText)},v.open("GET","./getIDRef"),v.send()};